<!-- HTML -->
<!DOCTYPE html>
<html>
<body>
  <ul id="view"></ul>
  <script>
    var socket = new WebSocket('ws://localhost:3000');

    var dataQueue = []; // Create a queue to store events
    var isProcessing = false; // Flag to indicate whether an event is being processed

    const DELAY = 100; // Delay time in ms to process the next event

    socket.onmessage = function(event) {
      // log(event.data)
      var arr = event.data.split("\n");
      for(var i = 0; i < arr.length; i++) {
        var data = arr[i];
        if (data != "") {
          dataQueue.push(data); // 将事件添加到队列
        }
      }
      processEvent(); // 开始处理事件
    };

    function processEvent() {
      if (isProcessing || dataQueue.length == 0) {
        // If an event is being processed, or the queue is empty, then return directly
        return;
      }

      isProcessing = true; // Mark that an event is being processed
      var data = dataQueue.shift(); // Take out an event from the queue

      if (data instanceof HTMLLIElement) {
        var li = data // activity destroy or fragment detach
        var isActivityWaitFragment = false
        log("checkWait " + li.children[0].textContent + " " + dataQueue.length + " " + !(dataQueue[0] instanceof String))
        if (li.children[0].textContent.endsWith('Destroyed') && dataQueue.length > 0 && !(dataQueue[0] instanceof String)) {
          var next = dataQueue[0]
          var [task, lifecycle] = parseData(next)
          // log("checkWait " + li.id + " " + task.next.value)
          if (li.id == task.next.value) {
            isActivityWaitFragment = true
            dataQueue.shift() // next
            dataQueue.unshift(li)
            var ul = document.getElementById("view");
            handleLifecycle(ul, task, lifecycle);
          }
        }
        if (!isActivityWaitFragment) {
          li.remove()
        }
      } else {
        var ul = document.getElementById("view");
        var [task, lifecycle] = parseData(data)
        handleLifecycle(ul, task, lifecycle);
      }

      setTimeout(function() {
        isProcessing = false; // Mark that the event processing has been completed
        processEvent(); // Recursive call to process the next event
      }, DELAY);
    }

    function parseData(data) {
      // log("parse: " + data);
      var data = data.split("ActivityTaskView.atv: ")[1];
      var s = data.split(" ");
      var task = s[0];
      var activity = s[1];
      var lifecycle = s[2];

      var t = new ListNode(task);
      var a = new ListNode(activity);
      t.next = a;

      if (s.length > 3) {
        var fragments = s[3].slice(1, -1).split(",");
        for (var i = fragments.length - 1; i >= 0; i--) {
          a.next = new ListNode(fragments[i]);
          a = a.next;
        }
      }
      return [t, lifecycle];
    }

    class ListNode {
      constructor(value, next = null) {
        this.value = value;
        this.next = next;
      }
    }

    function findChild(ul, id) {
      var children = ul.children
      for (var i = 0; i < children.length; i++) {
        if (children[i].id == id) {
          return children[i]
        }
      }
      return null
    }

    function log(msg) {
      console.log(msg)
    }

    function setText(li, name, lifecycle) {
      // log(name + " " + lifecycle)
      name = name.split("@")[0]
      lifecycle = lifecycle.replace("onActivity", "").replace("onFragment", "")
      var text = name + " " + lifecycle
      var t = li.children[0]
      if (t == null) {
        t = document.createElement("div")
        li.appendChild(t)
      }
      t.textContent = text
    }

    function handleLifecycle(ul, head, lifecycle) {
      var li = findChild(ul, head.value)
      if (li == null) {
        li = document.createElement("li")
        li.id = head.value
        setText(li, head.value, "")
        ul.appendChild(li)
      }

      if (head.next != null && head.next.value != null && head.next.value != "") {
        // head.next is null but head.next = object, object.value = ""
        var ull = li.children[1]
        if (ull != null) {
          // no op
        } else {
          ull = document.createElement("ul")
          li.appendChild(ull)
        }
        handleLifecycle(ull, head.next, lifecycle)
      } else { // update current lifecycle or remove
        setText(li, head.value, lifecycle)

        if (lifecycle.endsWith('ActivityDestroyed') || lifecycle.endsWith('Detached')) {
          // li.remove();
          dataQueue.unshift(li)
        }
      }
    }

  </script>
</body>
</html>